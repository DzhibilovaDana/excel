## Архитектура (кратко)
Проект преобразован в CLI-пайплайн без GUI. Главная точка входа — `processor.py` (`python processor.py --input ...`). Оркестратор загружает «актуальный» Excel (берёт `--output`, если есть, иначе копирует из `--input`), выбирает батчи необработанных строк, читает актуальный промт с диска, отправляет батч в Gemini, применяет Артефакт 1 в исходный лист, накапливает Артефакт 2 на листе `ФТ Mirapolis`, сохраняет после каждого батча и делает снапшоты в `STATE_DIR`. Надёжность обеспечивается логами вход/выход/парсинг и ретраями Gemini (3 попытки).

## Обязательные колонки входного листа
`L1, L2, L3, L4, L5, Mirapolis L4 (Да/Нет), Ответ Клиента, Комментарии/уточнения, Комментарии со встреч, Проблема текущего состояния, Предложение по решению /улучшению HCM, Функциональные требования`. Для результатов (Артефакт 1) добавляются/используются столбцы: `Инициирующее событие, Исполнитель, Описание шага, Действие в системе` и опционально `status`.

## Листы результата
- Исходный лист (обычно `Process` или первый лист): заполняются 4 колонки Артефакта 1. Строка считается обработанной, если эти 4 поля не пусты или `status=done`.
- Лист `ФТ Mirapolis`: колонки `L2 | Категория | Требование`, каждая строка — один пункт требований. Дедуп по (L2, Категория, Требование) при каждом батче.

## Возобновление
Если `--output` существует, работа продолжается с него; иначе создаётся копия из `--input`. После каждого батча делается снапшот в `STATE_DIR/output_batch_{k}.xlsx`. Ошибка парсинга Gemini не портит файл — батч прекращает работу с исключением, уже сохранённые данные остаются.

## Запуск
```bash
python processor.py --input input.xlsx --output output.xlsx --prompt ./prompts/prompt_main.md --batch-size 10 --model gemini-2.0-flash
```
Параметры можно задавать через ENV: `GEMINI_API_KEY`, `GEMINI_MODEL`, `BATCH_SIZE`, `PROMPT_FILE`, `INPUT_XLSX`, `OUTPUT_XLSX`, `LOG_DIR`, `STATE_DIR`.

## GUI (Tkinter)
В окне `main.py` есть блок "Батчевый анализ Gemini": выберите входной XLSX, PROMPT файл, путь для выходного XLSX, batch size, модель и API‑ключ, затем нажмите «Запустить батчи». Логи и снапшоты пишутся в указанные папки.

## Мини-тесты
Тесты покрывают выбор батча, применение Артефакта 1 и дедупликацию Артефакта 2: `pytest tests/test_processor.py`.

